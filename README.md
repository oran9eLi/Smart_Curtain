**系统设计说明**

1. 总体架构

本系统采用事件驱动的有限状态机（Event-driven FSM）架构作为核心控制模型，用于实现智能窗帘系统的可靠控制与状态管理。

系统通过引入统一的事件抽象与分发机制，将多源外部输入与具体控制逻辑解耦，从而提升系统的可维护性、可扩展性与安全性。

---

2. 事件抽象与统一入口

系统中所有外部输入均被统一抽象为事件（Event），包括但不限于：
	•	用户按键输入
	•	定时器中断（如超时事件）
	•	系统异常或内部触发条件

所有事件均通过统一的 **事件分发函数(System_Dispatch)** 进入系统，避免外部模块直接操作系统状态或硬件资源。

---

3. 基于状态的事件分发机制

事件分发模块根据当前系统状态，将事件路由至对应的状态处理函数。
系统仅响应该状态下被明确允许的事件，其余事件将被忽略或拒绝，从而形成一种基于状态的事件白名单机制。

该机制确保了系统行为的确定性，避免了非法状态跳转及异常行为扩散。

---

4. 事件处理与命令映射

在各状态对应的事件处理函数中，系统对底层输入事件进行语义解析，并将其进一步映射为高层用户命令或系统动作（如打开、关闭、停止等）。

通过该方式，实现了：
	•	用户输入与控制逻辑的解耦
	•	不同状态下对同一输入的差异化响应
	•	系统行为的集中管理与约束

---

5. 设计优势

该架构具备以下特点：
	•	系统行为由状态 + 事件共同决定，逻辑清晰、可预测
	•	外部输入无法直接驱动硬件，降低误操作风险
	•	易于引入超时保护、故障状态等安全机制
	•	模块边界清晰，便于单元测试与调试
	•	状态转移可控，适合安全关键型应用场景

---

6. 按键消抖策略

为了避免延时阻塞系统，采用了状态机消抖策略。
在按键按下时，系统进入一个消抖状态，并启动一个计数器，若在该状态下未检测到按键释放，则判定为有效按键。
若在消抖状态下检测到按键释放，则忽略该次按键事件。

---

7. 传感器触发策略

为避免传感器信号在临界点附近波动导致电机频繁启停，采用了滞回比较（Hysteresis）策略。
设置两个不同阈值——开启阈值与关闭阈值，两者之间形成缓冲区间。
只有当传感器测量值跨越整个滞回区间时，才触发状态改变，从而有效抑制临界点附近的频繁抖动。

---

8. 项目文件结构

```
Smart_Curtain/
├── Core/
│   ├── Inc/                    # 核心头文件
│   │   ├── main.h
│   │   ├── stm32f1xx_hal_conf.h
│   │   └── stm32f1xx_it.h
│   └── Src/                    # 核心源文件
│       ├── main.c              # 主程序（含FSM状态机）
│       ├── stm32f1xx_hal_msp.c
│       └── stm32f1xx_it.c
├── BSP/                        # 板级支持包
│   ├── BEEP/                   # 蜂鸣器
│   ├── BT/                     # 蓝牙
│   ├── DHT11/                  # 温湿度传感器
│   ├── KEY/                    # 按键
│   ├── LED/                    # LED
│   ├── LIGHT/                  # 光敏传感器
│   ├── MOTOR/                  # 步进电机
│   ├── MQ-7/                   # CO传感器
│   ├── OLED/                   # 显示屏（含菜单）
│   ├── SENSOR/                 # 传感器综合管理
│   └── VOICE/                  # 语音播报
├── EVENT/                      # 事件系统
│   ├── event.h
│   └── event.c
├── TIME/                       # 软件定时器
│   ├── soft_time.h
│   └── soft_time.c
├── Drivers/                    # HAL库和CMSIS
│   ├── STM32F1xx_HAL_Driver/
│   └── CMSIS/
└── README.md                   # 项目说明文档
```

---




**最后更新**: 2026年2月
**版本**: v1.0
